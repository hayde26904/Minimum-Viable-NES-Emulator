(()=>{"use strict";class e{static bytesToAddr(e,t){return t<<8|e}static addrToBytes(e){return new Uint8Array([255&e,(65280&e)>>8])}static hex(e){return null===e?"none":e.toString(16).toUpperCase()}}function t(e,t,r){e.setAreg(r)}function r(e,t,r){e.setXreg(r)}function o(e,t,r){e.setYreg(r)}function a(e,t,r){t.write(e.getAreg(),r)}function n(e,t,r){t.write(e.getXreg(),r)}function d(e,t,r){t.write(e.getYreg(),r)}function s(e,t,r){e.setPC(r)}var i;!function(e){e[e.none=0]="none",e[e.value=1]="value",e[e.pointer=2]="pointer"}(i||(i={}));const g=new Map([[0,{name:"BRK",method:function(e,t,r){},addrMode:0,argType:null}],[169,{name:"LDA",method:t,addrMode:1,argType:i.value}],[165,{name:"LDA",method:t,addrMode:2,argType:i.pointer}],[181,{name:"LDA",method:t,addrMode:3,argType:i.pointer}],[173,{name:"LDA",method:t,addrMode:5,argType:i.pointer}],[189,{name:"LDA",method:t,addrMode:6,argType:i.pointer}],[185,{name:"LDA",method:t,addrMode:7,argType:i.pointer}],[161,{name:"LDA",method:t,addrMode:11,argType:i.pointer}],[177,{name:"LDA",method:t,addrMode:12,argType:i.pointer}],[162,{name:"LDX",method:r,addrMode:1,argType:i.value}],[166,{name:"LDX",method:r,addrMode:2,argType:i.pointer}],[182,{name:"LDX",method:r,addrMode:4,argType:i.pointer}],[174,{name:"LDX",method:r,addrMode:5,argType:i.pointer}],[190,{name:"LDX",method:r,addrMode:7,argType:i.pointer}],[160,{name:"LDY",method:o,addrMode:1,argType:i.value}],[164,{name:"LDY",method:o,addrMode:2,argType:i.pointer}],[180,{name:"LDY",method:o,addrMode:3,argType:i.pointer}],[172,{name:"LDY",method:o,addrMode:5,argType:i.pointer}],[188,{name:"LDY",method:o,addrMode:6,argType:i.pointer}],[133,{name:"STA",method:a,addrMode:2,argType:i.value}],[149,{name:"STA",method:a,addrMode:3,argType:i.value}],[141,{name:"STA",method:a,addrMode:5,argType:i.value}],[157,{name:"STA",method:a,addrMode:6,argType:i.value}],[153,{name:"STA",method:a,addrMode:7,argType:i.value}],[129,{name:"STA",method:a,addrMode:11,argType:i.value}],[145,{name:"STA",method:a,addrMode:12,argType:i.value}],[134,{name:"STX",method:n,addrMode:2,argType:i.value}],[150,{name:"STX",method:n,addrMode:4,argType:i.value}],[142,{name:"STX",method:n,addrMode:5,argType:i.value}],[132,{name:"STY",method:d,addrMode:2,argType:i.value}],[148,{name:"STY",method:d,addrMode:3,argType:i.value}],[140,{name:"STY",method:d,addrMode:5,argType:i.value}],[170,{name:"TAX",method:function(e,t,r){e.setXreg(e.getAreg())},addrMode:0,argType:i.none}],[138,{name:"TXA",method:function(e,t,r){e.setAreg(e.getXreg())},addrMode:0,argType:i.none}],[168,{name:"TAY",method:function(e,t,r){e.setYreg(e.getAreg())},addrMode:0,argType:i.none}],[152,{name:"TYA",method:function(e,t,r){e.setAreg(e.getYreg())},addrMode:0,argType:i.none}],[186,{name:"TSX",method:function(e,t,r){e.setXreg(e.getSP())},addrMode:0,argType:i.none}],[154,{name:"TXS",method:function(e,t,r){e.setSP(e.getXreg())},addrMode:0,argType:i.none}],[76,{name:"JMP",method:s,addrMode:5,argType:i.value}],[108,{name:"JMP",method:s,addrMode:10,argType:i.value}],[32,{name:"JSR",method:function(t,r,o){let a=t.getPC(),[n,d]=e.addrToBytes(a);t.pushToStack(d),t.pushToStack(n),t.setPC(o)},addrMode:5,argType:i.value}],[96,{name:"RTS",method:function(t,r,o){let a=t.pullFromStack(),n=t.pullFromStack(),d=e.bytesToAddr(a,n);t.setPC(d),console.log(`Returned from subroutine to ${e.hex(d)}`)},addrMode:0,argType:i.none}]]);class h{constructor(e,t){this.memory=t||new Uint8Array(e).fill(0)}read(e){return this.memory[e]}write(e,t){this.memory[t]=e}getSize(){return this.memory.length}getMemory(){return this.memory}setMemory(e){this.memory=e}}class m extends h{constructor(e,t){super(e,t)}}var u;!function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(u||(u={}));const l=new Map([[0,1],[1,2],[2,2],[3,2],[4,2],[5,3],[6,3],[7,3],[8,1],[9,2],[10,3],[11,3],[12,3]]),c=new Map([[0,function(e,t,r,o){return null}],[1,function(e,t,r,o){return r[0]}],[2,function(e,t,r,o){return r[0]}],[3,function(e,t,r,o){return r[0]+t.getXreg()}],[4,function(e,t,r,o){return r[0]+t.getYreg()}],[5,function(t,r,o,a){return e.bytesToAddr(o[0],o[1])}],[6,function(t,r,o,a){return e.bytesToAddr(o[0],o[1])+r.getXreg()}],[7,function(t,r,o,a){return e.bytesToAddr(o[0],o[1])+r.getYreg()}],[8,function(e,t,r,o){return t.getAreg()}],[9,function(e,t,r,o){let a=128&~r[0]?r[0]:r[0]-256;return t.getPC()+a}],[10,function(t,r,o,a){return t.read(e.bytesToAddr(o[0],o[1]))}],[11,function(t,r,o,a){return t.read(e.bytesToAddr(o[0],o[1])+r.getXreg())}],[12,function(t,r,o,a){return e.bytesToAddr(o[0],o[1])+r.getYreg()}]]);class p{constructor(){this.ram=new m(65535),this.stack=new m(256),this.Areg=0,this.Xreg=0,this.Yreg=0,this.PC=0,this.SP=0,this.Cflag=!1,this.Zflag=!1,this.Nflag=!1}loadProgram(t){const r=function(e){let t=e.getMemory().slice(4);return{prgRomSize:16*t[0],chrRomSize:16*t[1],nametableMirroring:1&t[3],battery:Boolean(2&t[3]),mapperNumber:(240&t[3])>>4}}(t),o=t.getMemory().slice(16);console.log(r);for(let e=0;e<o.length;e++)this.ram.write(o[e],32768+e);console.log(this.ram.getMemory());const a=e.bytesToAddr(this.ram.read(65530),this.ram.read(65531)),n=e.bytesToAddr(this.ram.read(65532),this.ram.read(65533));console.log(`RESET: ${e.hex(n)}`),console.log(`NMI: ${e.hex(a)}`),this.PC=n}reset(){this.Areg=0,this.Xreg=0,this.Yreg=0,this.PC=0,this.SP=0,this.Cflag=!1,this.Zflag=!1,this.Nflag=!1}executeOperation(){let t=this.ram,r=t.read(this.PC);if(g.has(r)){let o=g.get(r),a=o.name,n=o.method,d=o.addrMode,s=o.argType,h=l.get(d),m=new Uint8Array(h-1);for(let e=0;e<m.length;e++)m[e]=t.read(this.PC+e+1);let u=c.get(d)(t,this,m,s);switch(s){case i.value:break;case i.pointer:u=t.read(u)}console.log(`${a} ${e.hex(u)}`),this.PC+=h,n(this,t,u)}else console.log(`Invalid or unimplemented opcode: ${e.hex(r)}`),this.PC++}setPC(e){this.PC=e}getPC(){return this.PC}setSP(t){this.SP=255&t,console.log("SET SP: ",e.hex(this.SP))}getSP(){return this.SP}setAreg(e){this.Areg=255&e,this.setFlags(e)}setXreg(e){this.Xreg=255&e,this.setFlags(e)}setYreg(e){this.Yreg=255&e,this.setFlags(e)}getAreg(){return this.Areg}getXreg(){return this.Xreg}getYreg(){return this.Yreg}pushToStack(t){this.SP--,this.stack.write(t,this.getSP()),console.log(`SP: ${e.hex(this.SP)}`)}pullFromStack(){let t=this.stack.read(this.getSP());return this.SP++,console.log(`SP: ${e.hex(this.SP)}`),t}setFlags(e){if(-1===e)return;let t=e;this.Cflag=this.overflow,this.Zflag=0===t,this.Nflag=!(128&~t)}getFlags(){return{Z:this.Zflag,N:this.Nflag,C:this.Cflag}}}class T extends h{constructor(e){super(e.length,e)}write(e,t){throw new Error("Did you just try to write to a ROM? Read-only memory? What is wrong with you? Why would you do that?")}}var y;let f=new class{constructor(){this.cpu=new p,this.currentPrgRom=null}loadProgram(e){this.cpu.reset(),this.cpu.loadProgram(e),this.currentPrgRom=e}step(){this.cpu.executeOperation()}};function M(){f.step(),requestAnimationFrame(M)}null===(y=document.getElementById("romInput"))||void 0===y||y.addEventListener("change",(e=>{const t=e.target;if(t.files&&t.files[0]){const e=t.files[0],r=new FileReader;r.onload=e=>{var t;if(null===(t=e.target)||void 0===t?void 0:t.result){const t=new Uint8Array(e.target.result);let r=new T(t);f.loadProgram(r),M()}},r.readAsArrayBuffer(e)}}))})();