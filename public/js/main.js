(()=>{"use strict";class e{static bytesToAddr(e,t){return t<<8|e}static addrToBytes(e){return new Uint8Array([255&e,(65280&e)>>8])}static Uint8ArrayToHex(e){return Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join(" ")}static hex(e){return null===e?"none":e.toString(16).toUpperCase().padStart(2,"0")}}function t(e,t){e.setYreg(t)}var r;!function(e){e[e.none=0]="none",e[e.value=1]="value",e[e.pointer=2]="pointer"}(r||(r={}));const o=[{name:"brk",method:function(e,t){},opCodes:[0],addrModes:[0],argTypes:[null]},{name:"lda",method:function(e,t){e.setAreg(t)},opCodes:[169,165,181,173,189,161,177],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer]},{name:"sta",method:function(e,t){e.writeToMem(e.getAreg(),t)},opCodes:[133,149,141,157,153,129,145],addrModes:[2,3,5,6,7,11,12],argTypes:[r.value,r.value,r.value,r.value,r.value,r.value,r.value]},{name:"ldx",method:function(e,t){e.setXreg(t)},opCodes:[162,166,182,174,190],addrModes:[1,2,4,5,7],argTypes:[r.value,r.pointer,r.pointer,r.pointer,r.pointer]},{name:"stx",method:function(e,t){e.writeToMem(e.getXreg(),t)},opCodes:[134,150,142],addrModes:[2,4,5],argTypes:[r.value,r.value,r.value]},{name:"ldy",method:t,opCodes:[160,164,180,172,188],addrModes:[1,2,3,5,6],argTypes:[r.value,r.pointer,r.pointer,r.pointer,r.pointer]},{name:"sty",method:t,opCodes:[132,148,140],addrModes:[2,3,5],argTypes:[r.value,r.value,r.value]},{name:"tax",method:function(e,t){e.setXreg(e.getAreg())},opCodes:[170],addrModes:[0],argTypes:[null]},{name:"txa",method:function(e,t){e.setAreg(e.getXreg())},opCodes:[138],addrModes:[0],argTypes:[null]},{name:"tay",method:function(e,t){e.setYreg(e.getAreg())},opCodes:[168],addrModes:[0],argTypes:[null]},{name:"tya",method:function(e,t){e.setAreg(e.getYreg())},opCodes:[152],addrModes:[0],argTypes:[null]},{name:"tsx",method:function(e,t){e.setXreg(e.getSP())},opCodes:[186],addrModes:[0],argTypes:[null]},{name:"txs",method:function(e,t){e.setSP(e.getXreg())},opCodes:[154],addrModes:[0],argTypes:[null]},{name:"jmp",method:function(e,t){e.setPC(t)},opCodes:[76,108],addrModes:[5,10],argTypes:[r.value,r.value]},{name:"jsr",method:function(t,r){let o=t.getPC(),[s,n]=e.addrToBytes(o);t.pushToStack(n),t.pushToStack(s),t.setPC(r)},opCodes:[32],addrModes:[5],argTypes:[r.value]},{name:"rts",method:function(t,r){let o=t.pullFromStack(),s=t.pullFromStack(),n=e.bytesToAddr(o,s);t.setPC(n),console.log(`Returned from subroutine to ${e.hex(n)}`)},opCodes:[96],addrModes:[0],argTypes:[null]},{name:"inc",method:function(e,t){e.writeToMem(e.readFromMem(t)+1,t)},opCodes:[230,246,238,254],addrModes:[2,3,5,6],argTypes:[r.value,r.value,r.value,r.value]},{name:"dec",method:function(e,t){e.writeToMem(e.readFromMem(t)-1,t)},opCodes:[198,214,206,222],addrModes:[2,3,5,6],argTypes:[r.value,r.value,r.value,r.value]},{name:"inx",method:function(e,t){e.setXreg(e.getXreg()+1)},opCodes:[230],addrModes:[0],argTypes:[null]},{name:"dex",method:function(e,t){e.setXreg(e.getXreg()-1)},opCodes:[202],addrModes:[0],argTypes:[null]},{name:"iny",method:function(e,t){e.setYreg(e.getYreg()+1)},opCodes:[200],addrModes:[0],argTypes:[null]},{name:"dey",method:function(e,t){e.setYreg(e.getYreg()-1)},opCodes:[136],addrModes:[0],argTypes:[null]},{name:"sec",method:function(e,t){e.setCarry()},opCodes:[56],addrModes:[0],argTypes:[null]},{name:"clc",method:function(e,t){e.clearCarry()},opCodes:[24],addrModes:[0],argTypes:[null]},{name:"adc",method:function(e,t){let r=Number(e.getFlags().C);e.setAreg(e.getAreg()+t+r),e.clearCarry()},opCodes:[105,101,117,109,125,121,97,113],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer]},{name:"sbc",method:function(e,t){let r=Number(!e.getFlags().C);e.setAreg(e.getAreg()-t-r),e.setCarry()},opCodes:[233,229,245,237,253,249,225,241],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer]},{name:"cmp",method:function(e,t){e.setFlags(e.getAreg()-t)},opCodes:[201,197,213,205,221,217,193,209],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer]},{name:"cpx",method:function(e,t){e.setFlags(e.getXreg()-t)},opCodes:[224,228,236],addrModes:[1,2,5],argTypes:[r.value,r.pointer,r.pointer]},{name:"cpy",method:function(e,t){e.setFlags(e.getYreg()-t)},opCodes:[192,196,204],addrModes:[1,2,5],argTypes:[r.value,r.pointer,r.pointer]},{name:"beq",method:function(e,t){e.getFlags().Z&&e.setPC(t)},opCodes:[240],addrModes:[9],argTypes:[r.value]},{name:"bne",method:function(e,t){e.getFlags().Z||e.setPC(t)},opCodes:[208],addrModes:[9],argTypes:[r.value]},{name:"bcc",method:function(e,t){e.getFlags().C||e.setPC(t)},opCodes:[144],addrModes:[9],argTypes:[r.value]},{name:"bcs",method:function(e,t){e.getFlags().C&&e.setPC(t)},opCodes:[176],addrModes:[9],argTypes:[r.value]},{name:"bmi",method:function(e,t){e.getFlags().N&&e.setPC(t)},opCodes:[48],addrModes:[9],argTypes:[r.value]},{name:"bpl",method:function(e,t){e.getFlags().N||e.setPC(t)},opCodes:[16],addrModes:[9],argTypes:[r.value]},{name:"and",method:function(e,t){e.setAreg(e.getAreg()&t)},opCodes:[41,37,53,45,61,57,33,49],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer,r.pointer]}];class s{constructor(e,t){this.memory=t||new Uint8Array(e).fill(0)}read(e){return this.memory[e]}write(e,t){this.memory[t]=e}getSize(){return this.memory.length}getMemory(){return this.memory}setMemory(e){this.memory=e}}class n extends s{constructor(e,t){super(e,t)}}const a=new Map([[0,1],[1,2],[2,2],[3,2],[4,2],[5,3],[6,3],[7,3],[8,1],[9,2],[10,3],[11,2],[12,2]]),d=new Map([[0,function(e,t,r,o){return null}],[1,function(e,t,r,o){return r[0]}],[2,function(e,t,r,o){return r[0]}],[3,function(e,t,r,o){return r[0]+t.getXreg()}],[4,function(e,t,r,o){return r[0]+t.getYreg()}],[5,function(t,r,o,s){return e.bytesToAddr(o[0],o[1])}],[6,function(t,r,o,s){return e.bytesToAddr(o[0],o[1])+r.getXreg()}],[7,function(t,r,o,s){return e.bytesToAddr(o[0],o[1])+r.getYreg()}],[8,function(e,t,r,o){return t.getAreg()}],[9,function(e,t,r,o){let s=128&~r[0]?r[0]:r[0]-254;return t.getPC()+s}],[10,function(t,r,o,s){return t.read(e.bytesToAddr(o[0],o[1]))}],[11,function(t,r,o,s){return t.read(e.bytesToAddr(o[0],o[1])+r.getXreg())}],[12,function(t,r,o,s){return e.bytesToAddr(o[0],o[1])+r.getYreg()}]]);class i{constructor(){this.ram=new n(65535),this.stack=new n(256),this.Areg=0,this.Xreg=0,this.Yreg=0,this.PC=0,this.SP=0,this.Cflag=!1,this.Zflag=!1,this.Nflag=!1}readFromMem(e){return this.ram.read(e)}writeToMem(e,t){this.ram.write(e,t)}reset(){this.Areg=0,this.Xreg=0,this.Yreg=0,this.PC=0,this.SP=0,this.Cflag=!1,this.Zflag=!1,this.Nflag=!1}loadProgram(t){for(let e=0;e<32767;e++)this.ram.write(t.read(e%t.getSize()),32768+e);console.log(this.ram.getMemory());const r=e.bytesToAddr(this.ram.read(65530),this.ram.read(65531)),o=e.bytesToAddr(this.ram.read(65532),this.ram.read(65533));console.log(`RESET: ${e.hex(o)}`),console.log(`NMI: ${e.hex(r)}`),this.PC=o}executeOperation(){let t=this.ram,s=t.read(this.PC),n=o.find((e=>e.opCodes.includes(s)));if(n){let o=n.name,i=n.method,g=n.opCodes.indexOf(s),l=n.addrModes[g],u=n.argTypes[g],p=a.get(l),h=new Uint8Array(p-1);for(let e=0;e<h.length;e++)h[e]=t.read(this.PC+e+1);let m=d.get(l)(t,this,h,u);switch(u){case r.value:break;case r.pointer:m=t.read(m)}console.log(`${e.hex(this.PC)}: ${o.toUpperCase()} ${e.hex(m)}`),this.PC+=p,i(this,m)}else console.log(`Invalid or unimplemented opcode: ${e.hex(s)}`),this.PC++}setPC(e){this.PC=e}getPC(){return this.PC}setSP(e){this.SP=255&e}getSP(){return this.SP}setAreg(e){this.setFlags(e),this.Areg=255&e}setXreg(e){this.Xreg=255&e,this.setFlags(e)}setYreg(e){this.Yreg=255&e,this.setFlags(e)}getAreg(){return this.Areg}getXreg(){return this.Xreg}getYreg(){return this.Yreg}pushToStack(e){this.SP--,this.stack.write(e,this.getSP())}pullFromStack(){let e=this.stack.read(this.getSP());return this.SP++,e}setCarry(){this.Cflag=!0}clearCarry(){this.Cflag=!1}setFlags(e){e>255?this.Cflag=!0:e<0&&(this.Cflag=!1),this.Zflag=0===e,this.Nflag=!(128&~e)}getFlags(){return{Z:this.Zflag,N:this.Nflag,C:this.Cflag}}}const g=[0,8191],l=["#7C7C7C","#0000FC","#0000BC","#4428BC","#940084","#A80020","#A81000","#881400","#503000","#007800","#006800","#005800","#004058","#000000","#000000","#000000","#BCBCBC","#0078F8","#0058F8","#6844FC","#D800CC","#E40058","#F83800","#E45C10","#AC7C00","#00B800","#00A800","#00A844","#008888","#000000","#000000","#000000","#F8F8F8","#3CBCFC","#6888FC","#9878F8","#F878F8","#F85898","#F87858","#FCA044","#F8B800","#B8F818","#58D854","#58F898","#00E8D8","#787878","#000000","#000000","#FCFCFC","#A4E4FC","#B8B8F8","#D8B8F8","#F8B8F8","#F8A4C0","#F0D0B0","#FCE0A8","#F8D878","#D8F878","#B8F8B8","#B8F8D8","#00FCFC","#F8D8F8","#000000","#000000"];class u{constructor(e){this.testPalette=[18,22,39,24],this.ctx=e,this.ram=new n(16383)}loadCHR(e){for(let t=0;t<g[1];t++)this.ram.write(e.read(t),t)}getColorIndex(e,t){return 0===t&&0===e?0:0===t&&1===e?1:1===t&&0===e?2:1===t&&1===e?3:void 0}drawSprite(e,t,r,o){let s=16*e,n=this.ram.getMemory().slice(s,s+8),a=this.ram.getMemory().slice(s+8,s+16);for(let e=0;e<n.length;e++){let o=n[e],s=a[e],d=t,i=r+e;for(let e=0;e<8;e++){let t=o>>7-e&1,r=s>>7-e&1;this.ctx.fillStyle=l[this.testPalette[this.getColorIndex(t,r)]],this.ctx.fillRect(d+e,i,1,1)}}}draw(){this.drawSprite(0,0,0,0),this.drawSprite(1,8,0,0),this.drawSprite(2,0,8,0),this.drawSprite(3,8,8,0),this.drawSprite(4,0,16,0),this.drawSprite(5,8,16,0),this.drawSprite(6,0,24,0),this.drawSprite(7,8,24,0)}}class p extends s{constructor(e){super(e.length,e)}write(e,t){throw new Error("Did you just try to write to a ROM? Read-only memory? What is wrong with you? Why would you do that?")}}var h,m;!function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(h||(h={}));let c=document.getElementById("canvas"),C=c.getContext("2d");c.width=1280,c.height=1120,C.scale(4,4);let y=new class{constructor(e){this.cpu=new i,this.ppu=new u(e),this.currentPrgRom=null}loadProgram(t){const r=function(e){let t=e.getMemory().slice(4);return{prgRomSize:16*t[0]*1024,chrRomSize:8*t[1]*1024,nametableMirroring:1&t[3],battery:Boolean(2&t[3]),mapperNumber:(240&t[3])>>4}}(t),o=t.getMemory().slice(16),s=new p(o.slice(0,r.prgRomSize)),n=new p(o.slice(r.prgRomSize,o.length-1));console.log(r),console.log(e.Uint8ArrayToHex(s.getMemory())),this.cpu.reset(),this.cpu.loadProgram(s),this.ppu.loadCHR(n),this.currentPrgRom=t,this.ppu.draw()}step(){this.cpu.executeOperation()}}(C);function f(){y.step(),requestAnimationFrame(f)}null===(m=document.getElementById("romInput"))||void 0===m||m.addEventListener("change",(e=>{const t=e.target;if(t.files&&t.files[0]){const e=t.files[0],r=new FileReader;r.onload=e=>{var t;if(null===(t=e.target)||void 0===t?void 0:t.result){const t=new Uint8Array(e.target.result);let r=new p(t);y.loadProgram(r),f()}},r.readAsArrayBuffer(e)}}))})();