(()=>{"use strict";function e(e,t,r){e.setAreg(r)}function t(e,t,r){t.write(e.getAreg(),r)}function r(e,t,r){e.setPC(r)}var n;!function(e){e[e.value=0]="value",e[e.pointer=1]="pointer"}(n||(n={}));const a=new Map([[0,{name:"BRK",method:function(e,t,r){},addrMode:0,argType:null}],[169,{name:"LDA",method:e,addrMode:1,argType:n.value}],[165,{name:"LDA",method:e,addrMode:2,argType:n.pointer}],[181,{name:"LDA",method:e,addrMode:3,argType:n.pointer}],[173,{name:"LDA",method:e,addrMode:5,argType:n.pointer}],[189,{name:"LDA",method:e,addrMode:6,argType:n.pointer}],[185,{name:"LDA",method:e,addrMode:7,argType:n.pointer}],[161,{name:"LDA",method:e,addrMode:11,argType:n.pointer}],[177,{name:"LDA",method:e,addrMode:12,argType:n.pointer}],[133,{name:"STA",method:t,addrMode:2,argType:n.value}],[149,{name:"STA",method:t,addrMode:3,argType:n.value}],[141,{name:"STA",method:t,addrMode:5,argType:n.value}],[157,{name:"STA",method:t,addrMode:6,argType:n.value}],[153,{name:"STA",method:t,addrMode:7,argType:n.value}],[129,{name:"STA",method:t,addrMode:11,argType:n.value}],[145,{name:"STA",method:t,addrMode:12,argType:n.value}],[76,{name:"JMP",method:r,addrMode:5,argType:n.value}],[108,{name:"JMP",method:r,addrMode:10,argType:n.value}]]);class o{constructor(e,t){this.memory=t||new Uint8Array(e).fill(0)}read(e){return this.memory[e]}write(e,t){this.memory[t]=e}getMemory(){return this.memory}setMemory(e){this.memory=e}}class s extends o{constructor(e,t){super(e,t)}}class d{static bytesToAddr(e,t){return t<<8|e}static hex(e){return null===e?"none":e.toString(16).toUpperCase()}}const i=new Map([[0,1],[1,2],[2,2],[3,2],[4,2],[5,3],[6,3],[7,3],[8,1],[9,2],[10,3],[11,3],[12,3]]),g=new Map([[0,function(e,t,r,n){return null}],[1,function(e,t,r,n){return r[0]}],[2,function(e,t,r,n){return r[0]}],[3,function(e,t,r,n){return r[0]+t.getXreg()}],[4,function(e,t,r,n){return r[0]+t.getYreg()}],[5,function(e,t,r,n){return d.bytesToAddr(r[0],r[1])}],[6,function(e,t,r,n){return d.bytesToAddr(r[0],r[1])+t.getXreg()}],[7,function(e,t,r,n){return d.bytesToAddr(r[0],r[1])+t.getYreg()}],[8,function(e,t,r,n){return t.getAreg()}],[9,function(e,t,r,n){let a=128&~r[0]?r[0]:r[0]-256;return t.getPC()+a}],[10,function(e,t,r,n){return e.read(d.bytesToAddr(r[0],r[1]))}],[11,function(e,t,r,n){return e.read(d.bytesToAddr(r[0],r[1])+t.getXreg())}],[12,function(e,t,r,n){return d.bytesToAddr(r[0],r[1])+t.getYreg()}]]);class l{constructor(){this.ram=new s(65535),this.Areg=0,this.Xreg=0,this.Yreg=0,this.PC=0,this.SP=0,this.Cflag=!1,this.Zflag=!1,this.Nflag=!1}loadProgram(e){let t=e.getMemory().slice(16);console.log(t);let r=this.PC=d.bytesToAddr(t[32762],t[32763]);console.log(d.hex(r));for(let e=0;e<t.length;e++)this.ram.write(t[e],r+e)}reset(){this.Areg=0,this.Xreg=0,this.Yreg=0,this.PC=0,this.SP=0,this.Cflag=!1,this.Zflag=!1,this.Nflag=!1}executeOperation(){let e=this.ram,t=e.read(this.PC);if(a.has(t)){let r=a.get(t),o=r.name,s=r.method,l=r.addrMode,h=r.argType,u=i.get(l),m=new Uint8Array(u-1);for(let t=0;t<m.length;t++)m[t]=e.read(this.PC+t+1);let c=g.get(l)(e,this,m,h);switch(h){case n.value:break;case n.pointer:c=e.read(c)}console.log(`${o} ${d.hex(c)}`),s(this,e,c),this.PC+=u}else console.log(`Invalid or unimplemented opcode: ${d.hex(t)}`),this.PC++}setPC(e){this.PC=e}getPC(){return this.PC}setAreg(e){this.Areg=255&e,this.setFlags(e)}setXreg(e){this.Xreg=255&e,this.setFlags(e)}setYreg(e){this.Yreg=255&e,this.setFlags(e)}getAreg(){return this.Areg}getXreg(){return this.Xreg}getYreg(){return this.Yreg}setFlags(e){if(-1===e)return;let t=e;this.Cflag=this.overflow,this.Zflag=0===t,this.Nflag=!(128&~t)}getFlags(){return{Z:this.Zflag,N:this.Nflag,C:this.Cflag}}}class h extends o{constructor(e){super(e.length,e)}}var u;let m=new class{constructor(){this.cpu=new l,this.currentPrgRom=null}loadProgram(e){this.cpu.reset(),this.cpu.loadProgram(e),this.currentPrgRom=e}step(){this.cpu.executeOperation()}};function c(){m.step()}null===(u=document.getElementById("romInput"))||void 0===u||u.addEventListener("change",(e=>{const t=e.target;if(t.files&&t.files[0]){const e=t.files[0],r=new FileReader;r.onload=e=>{var t;if(null===(t=e.target)||void 0===t?void 0:t.result){const t=new Uint8Array(e.target.result);let r=new h(t);m.loadProgram(r),setInterval(c,16)}},r.readAsArrayBuffer(e)}}))})();