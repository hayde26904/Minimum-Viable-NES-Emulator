(()=>{"use strict";class e{static bytesToAddr(e,t){return t<<8|e}static addrToBytes(e){return new Uint8Array([255&e,(65280&e)>>8])}static Uint8ArrayToHex(e){return Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join(" ")}static hex(e){return null===e?"none":e.toString(16).toUpperCase().padStart(2,"0")}static getBit(e,t){return e>>t&1}static boolsToBitmask(e){let t=0,r=1<<e.length-1;return e.forEach(((e,s)=>{e&&(t^=r>>s)})),t}static bitmaskToBools(e){let t=Math.floor(Math.log2(e))+1,r=1<<t-1,s=new Array;for(let o=0;o<t;o++)s[o]=!!(e>>t-1-o&1)&&Boolean(e^r>>o);return s}}function t(e,t){e.setYreg(t)}var r;!function(e){e[e.none=0]="none",e[e.value=1]="value",e[e.reference=2]="reference"}(r||(r={}));const s=[{name:"brk",method:function(e,t){},opCodes:[0],addrModes:[0],argTypes:[null],cycles:[1]},{name:"lda",method:function(e,t){e.setAreg(t)},opCodes:[169,165,181,173,189,161,177],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"sta",method:function(e,t){e.writeToMem(e.getAreg(),t)},opCodes:[133,149,141,157,153,129,145],addrModes:[2,3,5,6,7,11,12],argTypes:[r.value,r.value,r.value,r.value,r.value,r.value,r.value],cycles:[3,4,4,5,5,6,6]},{name:"ldx",method:function(e,t){e.setXreg(t)},opCodes:[162,166,182,174,190],addrModes:[1,2,4,5,7],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4]},{name:"stx",method:function(e,t){e.writeToMem(e.getXreg(),t)},opCodes:[134,150,142],addrModes:[2,4,5],argTypes:[r.value,r.value,r.value],cycles:[3,4,4]},{name:"ldy",method:t,opCodes:[160,164,180,172,188],addrModes:[1,2,3,5,6],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4]},{name:"sty",method:t,opCodes:[132,148,140],addrModes:[2,3,5],argTypes:[r.value,r.value,r.value],cycles:[3,4,4]},{name:"tax",method:function(e,t){e.setXreg(e.getAreg())},opCodes:[170],addrModes:[0],argTypes:[null],cycles:[2]},{name:"txa",method:function(e,t){e.setAreg(e.getXreg())},opCodes:[138],addrModes:[0],argTypes:[null],cycles:[2]},{name:"tay",method:function(e,t){e.setYreg(e.getAreg())},opCodes:[168],addrModes:[0],argTypes:[null],cycles:[2]},{name:"tya",method:function(e,t){e.setAreg(e.getYreg())},opCodes:[152],addrModes:[0],argTypes:[null],cycles:[2]},{name:"tsx",method:function(e,t){e.setXreg(e.getSP())},opCodes:[186],addrModes:[0],argTypes:[null],cycles:[2]},{name:"txs",method:function(e,t){e.setSP(e.getXreg())},opCodes:[154],addrModes:[0],argTypes:[null],cycles:[2]},{name:"jmp",method:function(e,t){e.setPC(t)},opCodes:[76,108],addrModes:[5,10],argTypes:[r.value,r.reference],cycles:[3,5]},{name:"jsr",method:function(t,r){let s=t.getPC(),[o,a]=e.addrToBytes(s);t.pushToStack(a),t.pushToStack(o),t.setPC(r)},opCodes:[32],addrModes:[5],argTypes:[r.value],cycles:[6]},{name:"rts",method:function(t,r){let s=t.pullFromStack(),o=t.pullFromStack(),a=t.pullFromStack(),i=e.bytesToAddr(s,o);t.setStatusReg(a),t.setPC(i),console.log(`Returned from subroutine to ${e.hex(i)}`)},opCodes:[96],addrModes:[0],argTypes:[null],cycles:[6]},{name:"rti",method:function(t,r){let s=t.pullFromStack(),o=t.pullFromStack(),a=t.pullFromStack(),i=e.bytesToAddr(s,o);t.setStatusReg(a),t.setPC(i),console.log(`Returned from interrupt to ${e.hex(i)}`)},opCodes:[64],addrModes:[0],argTypes:[null],cycles:[6]},{name:"inc",method:function(e,t){e.writeToMem(e.readFromMem(t)+1,t)},opCodes:[230,246,238,254],addrModes:[2,3,5,6],argTypes:[r.value,r.value,r.value,r.value],cycles:[5,6,6,7]},{name:"dec",method:function(e,t){e.writeToMem(e.readFromMem(t)-1,t)},opCodes:[198,214,206,222],addrModes:[2,3,5,6],argTypes:[r.value,r.value,r.value,r.value],cycles:[5,6,6,7]},{name:"inx",method:function(e,t){e.setXreg(e.getXreg()+1)},opCodes:[232],addrModes:[0],argTypes:[null],cycles:[2]},{name:"dex",method:function(e,t){e.setXreg(e.getXreg()-1)},opCodes:[202],addrModes:[0],argTypes:[null],cycles:[2]},{name:"iny",method:function(e,t){e.setYreg(e.getYreg()+1)},opCodes:[200],addrModes:[0],argTypes:[null],cycles:[2]},{name:"dey",method:function(e,t){e.setYreg(e.getYreg()-1)},opCodes:[136],addrModes:[0],argTypes:[null],cycles:[2]},{name:"sec",method:function(e,t){e.setCarry()},opCodes:[56],addrModes:[0],argTypes:[null],cycles:[2]},{name:"clc",method:function(e,t){e.clearCarry()},opCodes:[24],addrModes:[0],argTypes:[null],cycles:[2]},{name:"adc",method:function(e,t){let r=Number(e.getFlags().C);e.setAreg(e.getAreg()+t+r),e.clearCarry()},opCodes:[105,101,117,109,125,121,97,113],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"sbc",method:function(e,t){let r=Number(!e.getFlags().C);e.setAreg(e.getAreg()-t-r),e.setCarry()},opCodes:[233,229,245,237,253,249,225,241],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"cmp",method:function(e,t){e.setFlags(e.getAreg()-t)},opCodes:[201,197,213,205,221,217,193,209],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"cpx",method:function(e,t){e.setFlags(e.getXreg()-t)},opCodes:[224,228,236],addrModes:[1,2,5],argTypes:[r.value,r.reference,r.reference],cycles:[2,3,4]},{name:"cpy",method:function(e,t){e.setFlags(e.getYreg()-t)},opCodes:[192,196,204],addrModes:[1,2,5],argTypes:[r.value,r.reference,r.reference],cycles:[2,3,4]},{name:"bit",method:function(e,t){e.setFlags(t),128&~t?e.clearNegative():e.setNegative(),64&~t?e.clearOverflow():e.setOverflow()},opCodes:[36,44],addrModes:[2,5],argTypes:[r.reference,r.reference],cycles:[3,4]},{name:"beq",method:function(e,t){e.getFlags().Z&&e.setPC(t)},opCodes:[240],addrModes:[9],argTypes:[r.value],cycles:[2]},{name:"bne",method:function(e,t){e.getFlags().Z||e.setPC(t)},opCodes:[208],addrModes:[9],argTypes:[r.value],cycles:[2]},{name:"bcc",method:function(e,t){e.getFlags().C||e.setPC(t)},opCodes:[144],addrModes:[9],argTypes:[r.value],cycles:[2]},{name:"bcs",method:function(e,t){e.getFlags().C&&e.setPC(t)},opCodes:[176],addrModes:[9],argTypes:[r.value],cycles:[2]},{name:"bmi",method:function(e,t){e.getFlags().N&&e.setPC(t)},opCodes:[48],addrModes:[9],argTypes:[r.value],cycles:[2]},{name:"bpl",method:function(e,t){e.getFlags().N||e.setPC(t)},opCodes:[16],addrModes:[9],argTypes:[r.value],cycles:[2]},{name:"and",method:function(e,t){e.setAreg(e.getAreg()&t)},opCodes:[41,37,53,45,61,57,33,49],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4,4,6,5]}];class o{constructor(e,t){this.memory=t||new Uint8Array(e).fill(0)}read(e){return this.memory[e]}write(e,t){this.memory[t]=e}getSize(){return this.memory.length}getMemory(){return this.memory}setMemory(e){this.memory=e}}class a extends o{constructor(e,t){super(e,t)}}const i=new Map([[0,1],[1,2],[2,2],[3,2],[4,2],[5,3],[6,3],[7,3],[8,1],[9,2],[10,3],[11,2],[12,2]]),n=new Map([[0,function(e,t,r,s){return null}],[1,function(e,t,r,s){return r[0]}],[2,function(e,t,r,s){return r[0]}],[3,function(e,t,r,s){return r[0]+t.getXreg()}],[4,function(e,t,r,s){return r[0]+t.getYreg()}],[5,function(t,r,s,o){return e.bytesToAddr(s[0],s[1])}],[6,function(t,r,s,o){return e.bytesToAddr(s[0],s[1])+r.getXreg()}],[7,function(t,r,s,o){return e.bytesToAddr(s[0],s[1])+r.getYreg()}],[8,function(e,t,r,s){return t.getAreg()}],[9,function(e,t,r,s){let o=128&~r[0]?r[0]+2:r[0]-254;return t.getPC()+o}],[10,function(t,r,s,o){let a=void 0===s[1],i=t.read(s[0]),n=t.read(a?s[0]+1:s[1]);return e.bytesToAddr(i,n)}],[11,function(t,r,s,o){let a=void 0===s[1],i=r.getXreg(),n=t.read(s[0]+i),l=t.read((a?s[0]+1:s[1])+i);return e.bytesToAddr(n,l)}],[12,function(t,r,s,o){let a=void 0===s[1],i=t.read(s[0]),n=t.read(a?s[0]+1:s[1]);return e.bytesToAddr(i,n)+r.getYreg()}]]),l=["#7C7C7C","#0000FC","#0000BC","#4428BC","#940084","#A80020","#A81000","#881400","#503000","#007800","#006800","#005800","#004058","#000000","#000000","#000000","#BCBCBC","#0078F8","#0058F8","#6844FC","#D800CC","#E40058","#F83800","#E45C10","#AC7C00","#00B800","#00A800","#00A844","#008888","#000000","#000000","#000000","#F8F8F8","#3CBCFC","#6888FC","#9878F8","#F878F8","#F85898","#F87858","#FCA044","#F8B800","#B8F818","#58D854","#58F898","#00E8D8","#787878","#000000","#000000","#FCFCFC","#A4E4FC","#B8B8F8","#D8B8F8","#F8B8F8","#F8A4C0","#F0D0B0","#FCE0A8","#F8D878","#D8F878","#B8F8B8","#B8F8D8","#00FCFC","#F8D8F8","#000000","#000000"];class d extends o{constructor(e){super(e.length,e)}write(e,t){throw new Error("Did you just try to write to a ROM? Read-only memory? What is wrong with you? Why would you do that?")}}var c;!function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(c||(c={}));class h{constructor(){}setPrgRom(e){this.rom=e}}const g=new Map([[0,new class extends h{constructor(){super()}read(e){return this.rom.read(e-32768)}write(e,t){}}]]);var u,m;let f,p=document.getElementById("canvas"),y=p.getContext("2d");p.width=1024,p.height=960,y.scale(4,4);let C=new class{constructor(){this.Areg=0,this.Xreg=0,this.Yreg=0,this.PC=0,this.SP=0,this.Cflag=!1,this.Zflag=!1,this.Nflag=!1,this.Iflag=!1,this.Oflag=!1,this.Dflag=!1,this.Bflag=!1,this.NMIvector=0,this.resetVector=0,this.IRQvector=0,this.stack=new a(256)}setBus(e){this.bus=e}readFromMem(e){return this.bus.read(e)}writeToMem(e,t){this.bus.write(e,t)}reset(){this.Areg=0,this.Xreg=0,this.Yreg=0,this.PC=0,this.SP=0,this.Cflag=!1,this.Zflag=!1,this.Nflag=!1,this.Iflag=!1,this.Oflag=!1,this.Dflag=!1,this.NMIvector=0,this.resetVector=0,this.IRQvector=0}loadProgram(t){this.NMIvector=e.bytesToAddr(this.bus.read(65530),this.bus.read(65531)),this.resetVector=e.bytesToAddr(this.bus.read(65532),this.bus.read(65533)),console.log(`NMI: ${e.hex(this.NMIvector)}`),console.log(`RESET: ${e.hex(this.resetVector)}`),this.PC=this.resetVector}executeNextOperation(){let t=this.bus.read(this.PC),o=s.find((e=>e.opCodes.includes(t)));if(o){o.name;let e=o.method,s=o.opCodes.indexOf(t),a=o.addrModes[s],l=o.argTypes[s],d=o.cycles[s],c=i.get(a),h=new Uint8Array(c-1);for(let e=0;e<h.length;e++)h[e]=this.bus.read(this.PC+e+1);let g,u=n.get(a)(this.bus,this,h,l);switch(l){case r.value:g=u;break;case r.reference:g=this.bus.read(u)}return this.PC,this.PC+=c,e(this,g),d}return console.log(`Invalid or unimplemented opcode: ${e.hex(t)}`),this.PC++,1}goToNMI(){let[t,r]=e.addrToBytes(this.getPC());this.setInterruptDisable(),this.pushToStack(this.getStatusReg()),this.pushToStack(r),this.pushToStack(t),this.setPC(this.NMIvector)}setPC(e){this.PC=e}getPC(){return this.PC}setSP(e){this.SP=255&e}getSP(){return this.SP}setAreg(e){this.setFlags(e),this.Areg=255&e}setXreg(e){this.Xreg=255&e,this.setFlags(e)}setYreg(e){this.Yreg=255&e,this.setFlags(e)}getAreg(){return this.Areg}getXreg(){return this.Xreg}getYreg(){return this.Yreg}getStatusReg(){let t=this.getFlags();return e.boolsToBitmask([t.N,t.O,!0,t.B,t.D,t.I,t.Z,t.C])}setStatusReg(t){let r;[this.Nflag,this.Oflag,r,this.Bflag,this.Dflag,this.Iflag,this.Zflag,this.Cflag]=e.bitmaskToBools(t)}pushToStack(t){this.SP--,this.stack.write(t,this.getSP()),console.log(`Pushed ${e.hex(t)} SP: ${e.hex(this.SP)}`)}pullFromStack(){let t=this.stack.read(this.getSP());return this.SP++,console.log(`SP: ${e.hex(this.SP)}`),t}setCarry(){this.Cflag=!0}clearCarry(){this.Cflag=!1}setZero(){this.Zflag=!0}clearZero(){this.Zflag=!1}setNegative(){this.Nflag=!0}clearNegative(){this.Nflag=!1}setOverflow(){this.Oflag=!0}clearOverflow(){this.Oflag=!1}setInterruptDisable(){this.Iflag=!0}clearInterruptDisable(){this.Iflag=!1}setFlags(e){e>255?this.Cflag=!0:e<0&&(this.Cflag=!1),this.Zflag=0===e,this.Nflag=!(128&~e)}getFlags(){return{Z:this.Zflag,N:this.Nflag,C:this.Cflag,I:this.Iflag,O:this.Oflag,D:this.Dflag,B:this.Bflag}}},T=new class{constructor(e){this.writeCounter=0,this.scrollX=0,this.scrollY=0,this.oamDmaSet=!1,this.NMIenabled=!0,this.masterSlave=!1,this.spriteSizeMode=!1,this.backgroundAddr=!1,this.spriteAddr=!1,this.vramIncrement=!1,this.baseNametableAddr=0,this.emphasizeBlue=!1,this.emphasizeGreen=!1,this.emphasizeRed=!1,this.showSprites=!1,this.showBackground=!1,this.showLeftSprites=!1,this.showLeftBackground=!1,this.greyscale=!1,this.inVblank=!0,this.spriteZeroHit=!1,this.spriteOverflow=!1,this.testPalette=[18,22,39,24],this.ctx=e,this.patternTable0=new a(4096),this.patternTable1=new a(4096),this.backgroundPalette=new a(16),this.spritePalette=new a(16),this.oam=new a(255)}setNMIhandler(e){this.NMIhandler=e}setBus(e){this.bus=e}loadCHR(e){for(let t=0;t<this.patternTable0.getSize();t++)this.patternTable0.write(e.read(t),t),this.patternTable1.write(e.read(t),t+this.patternTable0.getSize())}copySpritesFromOamDma(){let t=e.bytesToAddr(this.oamAddr,this.oamDma);for(let e=0;e<this.oam.getSize();e++)this.oam.write(this.bus.read(t+e),e)}tick(){}NMI(){this.NMIenabled&&this.NMIhandler()}readRegister(t){switch(t){case 8194:return this.writeCounter=0,e.boolsToBitmask([this.inVblank,this.spriteZeroHit,this.spriteOverflow,!1,!1,!1,!1,!1]);case 8195:return this.oamAddr;case 8196:return this.oam.read(this.oamAddr);case 8199:return 0;default:throw new Error(`Attempted read from invalid PPU register address: ${e.hex(t)}`)}}writeRegister(t,r){switch(r){case 8192:[this.NMIenabled,this.masterSlave,this.spriteSizeMode,this.backgroundAddr,this.spriteAddr,this.vramIncrement]=e.bitmaskToBools(t),this.baseNametableAddr=3&t;break;case 8193:[this.emphasizeBlue,this.emphasizeGreen,this.emphasizeRed,this.showSprites,this.showBackground,this.showLeftSprites,this.showLeftBackground,this.greyscale]=e.bitmaskToBools(t);break;case 16404:this.oamDma=t;break;case 8195:this.oamAddr=t;break;case 8196:this.oam.write(t,this.oamAddr);break;case 8197:0===this.writeCounter?this.scrollX=t:1===this.writeCounter&&(this.scrollY=t),this.writeCounter++,this.writeCounter>1&&(this.writeCounter=0);break;case 8198:0===this.writeCounter?this.addr|=t<<8:1===this.writeCounter&&(this.addr|=t),this.writeCounter++,this.writeCounter>1&&(this.writeCounter=0);break;case 8199:break;default:throw new Error(`Attempted write to invalid PPU register address: ${e.hex(r)}`)}}getColorIndex(e,t){return 0===t&&0===e?0:0===t&&1===e?1:1===t&&0===e?2:1===t&&1===e?3:void 0}drawTile(e,t,r,s){let o=16*e,a=this.patternTable0.getMemory().slice(o,o+8),i=this.patternTable0.getMemory().slice(o+8,o+16);for(let e=0;e<a.length;e++){let s=a[e],o=i[e],n=t,d=r+e;for(let e=0;e<8;e++){let t=s>>7-e&1,r=o>>7-e&1;this.ctx.fillStyle=l[this.testPalette[this.getColorIndex(t,r)]],this.ctx.fillRect(n+e,d,1,1)}}}drawSprites(){for(let t=0;t+4<this.oam.getSize();t+=4){let r=this.oam.read(t+1),s=this.oam.read(t+3),o=this.oam.read(t),a=this.oam.read(t+2);0!==r&&console.log(`Drawing sprite $${e.hex(r)} at X: ${e.hex(s)} Y: ${e.hex(o)}`),this.drawTile(r,s,o,a)}}draw(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.copySpritesFromOamDma(),this.drawSprites()}}(y);T.setNMIhandler(C.goToNMI.bind(C));let w,M=new class{constructor(e,t){this.cpu=e,this.ppu=t,this.ram=new a(2048)}setMapper(e){this.mapper=e}read(e){return e<8192?this.ram.read(e%2048):e<16384?this.ppu.readRegister(8192+e%8):e>=32768?this.mapper.read(e):0}write(e,t){t<8192?this.ram.write(e,t%2048):t<16384?this.ppu.writeRegister(e,8192+t%8):16404===t?this.ppu.writeRegister(e,t):t>32768&&this.mapper.write(e,t)}}(C,T);C.setBus(M),T.setBus(M),null===(u=document.getElementById("nmi-btn"))||void 0===u||u.addEventListener("click",T.NMI.bind(T)),null===(m=document.getElementById("romInput"))||void 0===m||m.addEventListener("change",(t=>{const r=t.target;if(r.files&&r.files[0]){const t=r.files[0],s=new FileReader;s.onload=t=>{var r;if(null===(r=t.target)||void 0===r?void 0:r.result){const r=new Uint8Array(t.target.result);!function(t){const r=function(e){let t=e.getMemory().slice(4);return{prgRomSize:16*t[0]*1024,chrRomSize:8*t[1]*1024,nametableMirroring:1&t[3],battery:Boolean(2&t[3]),mapperNumber:(240&t[3])>>4}}(t),s=t.getMemory().slice(16),o=new d(s.slice(0,r.prgRomSize)),a=new d(s.slice(r.prgRomSize,s.length-1));console.log(r),console.log(e.Uint8ArrayToHex(o.getMemory())),f=g.get(r.mapperNumber),f.setPrgRom(o),M.setMapper(f),console.log(f),C.reset(),C.loadProgram(o),T.loadCHR(a),w=t}(new d(r)),v()}},s.readAsArrayBuffer(t)}}));let b=performance.now();function v(){const t=performance.now(),r=(t-b)/(1e3/60),s=Math.floor(27120*r),o=Math.floor(2486*r);let a=0;for(console.log(`FRAME START  PC: ${e.hex(C.getPC())}`);a<s;)a+=C.executeNextOperation(),T.tick();for(console.log(`FRAME END  PC: ${e.hex(C.getPC())}`),a=0,T.NMI(),console.log(`NMI START  PC: ${e.hex(C.getPC())}`);a<o;)a+=C.executeNextOperation(),T.tick();console.log(`NMI END  PC: ${e.hex(C.getPC())}`),T.draw(),b=t,requestAnimationFrame(v)}})();