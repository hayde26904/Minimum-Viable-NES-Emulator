(()=>{"use strict";class e{static bytesToAddr(e,t){return t<<8|e}static addrToBytes(e){return new Uint8Array([255&e,(65280&e)>>8])}static Uint8ArrayToHex(e){return Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join(" ")}static hex(e){return null===e?"none":e.toString(16).toUpperCase().padStart(2,"0")}}function t(e,t){e.setYreg(t)}var r;!function(e){e[e.none=0]="none",e[e.value=1]="value",e[e.reference=2]="reference"}(r||(r={}));const s=[{name:"brk",method:function(e,t){},opCodes:[0],addrModes:[0],argTypes:[null],cycles:[1]},{name:"lda",method:function(e,t){e.setAreg(t)},opCodes:[169,165,181,173,189,161,177],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"sta",method:function(e,t){e.writeToMem(e.getAreg(),t)},opCodes:[133,149,141,157,153,129,145],addrModes:[2,3,5,6,7,11,12],argTypes:[r.value,r.value,r.value,r.value,r.value,r.value,r.value],cycles:[3,4,4,5,5,6,6]},{name:"ldx",method:function(e,t){e.setXreg(t)},opCodes:[162,166,182,174,190],addrModes:[1,2,4,5,7],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4]},{name:"stx",method:function(e,t){e.writeToMem(e.getXreg(),t)},opCodes:[134,150,142],addrModes:[2,4,5],argTypes:[r.value,r.value,r.value],cycles:[3,4,4]},{name:"ldy",method:t,opCodes:[160,164,180,172,188],addrModes:[1,2,3,5,6],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4]},{name:"sty",method:t,opCodes:[132,148,140],addrModes:[2,3,5],argTypes:[r.value,r.value,r.value],cycles:[3,4,4]},{name:"tax",method:function(e,t){e.setXreg(e.getAreg())},opCodes:[170],addrModes:[0],argTypes:[null],cycles:[2]},{name:"txa",method:function(e,t){e.setAreg(e.getXreg())},opCodes:[138],addrModes:[0],argTypes:[null],cycles:[2]},{name:"tay",method:function(e,t){e.setYreg(e.getAreg())},opCodes:[168],addrModes:[0],argTypes:[null],cycles:[2]},{name:"tya",method:function(e,t){e.setAreg(e.getYreg())},opCodes:[152],addrModes:[0],argTypes:[null],cycles:[2]},{name:"tsx",method:function(e,t){e.setXreg(e.getSP())},opCodes:[186],addrModes:[0],argTypes:[null],cycles:[2]},{name:"txs",method:function(e,t){e.setSP(e.getXreg())},opCodes:[154],addrModes:[0],argTypes:[null],cycles:[2]},{name:"jmp",method:function(e,t){e.setPC(t)},opCodes:[76,108],addrModes:[5,10],argTypes:[r.value,r.reference],cycles:[3,5]},{name:"jsr",method:function(t,r){let s=t.getPC(),[o,a]=e.addrToBytes(s);t.pushToStack(a),t.pushToStack(o),t.setPC(r)},opCodes:[32],addrModes:[5],argTypes:[r.value],cycles:[6]},{name:"rts",method:function(t,r){let s=t.pullFromStack(),o=t.pullFromStack(),a=t.pullFromStack(),n=e.bytesToAddr(s,o);t.setStatusReg(a),t.setPC(n),console.log(`Returned from subroutine to ${e.hex(n)}`)},opCodes:[96],addrModes:[0],argTypes:[null],cycles:[6]},{name:"rti",method:function(t,r){let s=t.pullFromStack(),o=t.pullFromStack(),a=e.bytesToAddr(s,o);t.setPC(a),console.log(`Returned from interrupt to ${e.hex(a)}`)},opCodes:[64],addrModes:[0],argTypes:[null],cycles:[6]},{name:"inc",method:function(e,t){e.writeToMem(e.readFromMem(t)+1,t)},opCodes:[230,246,238,254],addrModes:[2,3,5,6],argTypes:[r.value,r.value,r.value,r.value],cycles:[5,6,6,7]},{name:"dec",method:function(e,t){e.writeToMem(e.readFromMem(t)-1,t)},opCodes:[198,214,206,222],addrModes:[2,3,5,6],argTypes:[r.value,r.value,r.value,r.value],cycles:[5,6,6,7]},{name:"inx",method:function(e,t){e.setXreg(e.getXreg()+1)},opCodes:[230],addrModes:[0],argTypes:[null],cycles:[2]},{name:"dex",method:function(e,t){e.setXreg(e.getXreg()-1)},opCodes:[202],addrModes:[0],argTypes:[null],cycles:[2]},{name:"iny",method:function(e,t){e.setYreg(e.getYreg()+1)},opCodes:[200],addrModes:[0],argTypes:[null],cycles:[2]},{name:"dey",method:function(e,t){e.setYreg(e.getYreg()-1)},opCodes:[136],addrModes:[0],argTypes:[null],cycles:[2]},{name:"sec",method:function(e,t){e.setCarry()},opCodes:[56],addrModes:[0],argTypes:[null],cycles:[2]},{name:"clc",method:function(e,t){e.clearCarry()},opCodes:[24],addrModes:[0],argTypes:[null],cycles:[2]},{name:"adc",method:function(e,t){let r=Number(e.getFlags().C);e.setAreg(e.getAreg()+t+r),e.clearCarry()},opCodes:[105,101,117,109,125,121,97,113],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"sbc",method:function(e,t){let r=Number(!e.getFlags().C);e.setAreg(e.getAreg()-t-r),e.setCarry()},opCodes:[233,229,245,237,253,249,225,241],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"cmp",method:function(e,t){e.setFlags(e.getAreg()-t)},opCodes:[201,197,213,205,221,217,193,209],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"cpx",method:function(e,t){e.setFlags(e.getXreg()-t)},opCodes:[224,228,236],addrModes:[1,2,5],argTypes:[r.value,r.reference,r.reference],cycles:[2,3,4]},{name:"cpy",method:function(e,t){e.setFlags(e.getYreg()-t)},opCodes:[192,196,204],addrModes:[1,2,5],argTypes:[r.value,r.reference,r.reference],cycles:[2,3,4]},{name:"bit",method:function(e,t){e.setFlags(e.getAreg()&t)},opCodes:[36,44],addrModes:[2,5],argTypes:[r.reference,r.reference],cycles:[3,4]},{name:"beq",method:function(e,t){e.getFlags().Z&&e.setPC(t)},opCodes:[240],addrModes:[9],argTypes:[r.value],cycles:[2]},{name:"bne",method:function(e,t){e.getFlags().Z||e.setPC(t)},opCodes:[208],addrModes:[9],argTypes:[r.value],cycles:[2]},{name:"bcc",method:function(e,t){e.getFlags().C||e.setPC(t)},opCodes:[144],addrModes:[9],argTypes:[r.value],cycles:[2]},{name:"bcs",method:function(e,t){e.getFlags().C&&e.setPC(t)},opCodes:[176],addrModes:[9],argTypes:[r.value],cycles:[2]},{name:"bmi",method:function(e,t){e.getFlags().N&&e.setPC(t)},opCodes:[48],addrModes:[9],argTypes:[r.value],cycles:[2]},{name:"bpl",method:function(e,t){e.getFlags().N||e.setPC(t)},opCodes:[16],addrModes:[9],argTypes:[r.value],cycles:[2]},{name:"and",method:function(e,t){e.setAreg(e.getAreg()&t)},opCodes:[41,37,53,45,61,57,33,49],addrModes:[1,2,3,5,6,7,11,12],argTypes:[r.value,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference,r.reference],cycles:[2,3,4,4,4,4,6,5]}];class o{constructor(e,t){this.memory=t||new Uint8Array(e).fill(0)}read(e){return this.memory[e]}write(e,t){this.memory[t]=e}getSize(){return this.memory.length}getMemory(){return this.memory}setMemory(e){this.memory=e}}class a extends o{constructor(e,t){super(e,t)}}const n=new Map([[0,1],[1,2],[2,2],[3,2],[4,2],[5,3],[6,3],[7,3],[8,1],[9,2],[10,3],[11,2],[12,2]]),d=new Map([[0,function(e,t,r,s){return null}],[1,function(e,t,r,s){return r[0]}],[2,function(e,t,r,s){return r[0]}],[3,function(e,t,r,s){return r[0]+t.getXreg()}],[4,function(e,t,r,s){return r[0]+t.getYreg()}],[5,function(t,r,s,o){return e.bytesToAddr(s[0],s[1])}],[6,function(t,r,s,o){return e.bytesToAddr(s[0],s[1])+r.getXreg()}],[7,function(t,r,s,o){return e.bytesToAddr(s[0],s[1])+r.getYreg()}],[8,function(e,t,r,s){return t.getAreg()}],[9,function(e,t,r,s){let o=128&~r[0]?r[0]+2:r[0]-254;return t.getPC()+o}],[10,function(t,r,s,o){let a=void 0===s[1],n=t.read(s[0]),d=t.read(a?s[0]+1:s[1]);return e.bytesToAddr(n,d)}],[11,function(t,r,s,o){let a=void 0===s[1],n=r.getXreg(),d=t.read(s[0]+n),l=t.read((a?s[0]+1:s[1])+n);return e.bytesToAddr(d,l)}],[12,function(t,r,s,o){let a=void 0===s[1],n=t.read(s[0]),d=t.read(a?s[0]+1:s[1]);return console.log(`lo: ${n}  hi: ${d}`),e.bytesToAddr(n,d)+r.getYreg()}]]),l=[0,8191],i=["#7C7C7C","#0000FC","#0000BC","#4428BC","#940084","#A80020","#A81000","#881400","#503000","#007800","#006800","#005800","#004058","#000000","#000000","#000000","#BCBCBC","#0078F8","#0058F8","#6844FC","#D800CC","#E40058","#F83800","#E45C10","#AC7C00","#00B800","#00A800","#00A844","#008888","#000000","#000000","#000000","#F8F8F8","#3CBCFC","#6888FC","#9878F8","#F878F8","#F85898","#F87858","#FCA044","#F8B800","#B8F818","#58D854","#58F898","#00E8D8","#787878","#000000","#000000","#FCFCFC","#A4E4FC","#B8B8F8","#D8B8F8","#F8B8F8","#F8A4C0","#F0D0B0","#FCE0A8","#F8D878","#D8F878","#B8F8B8","#B8F8D8","#00FCFC","#F8D8F8","#000000","#000000"];class c extends o{constructor(e){super(e.length,e)}write(e,t){throw new Error("Did you just try to write to a ROM? Read-only memory? What is wrong with you? Why would you do that?")}}var g,h,u;!function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(g||(g={}));let m=document.getElementById("canvas"),f=m.getContext("2d");m.width=510,m.height=480,f.scale(3,3);let y,p=new class{constructor(){this.Areg=0,this.Xreg=0,this.Yreg=0,this.PC=0,this.SP=0,this.Cflag=!1,this.Zflag=!1,this.Nflag=!1,this.Iflag=!1,this.Oflag=!1,this.Dflag=!1,this.Bflag=!1,this.NMIvector=0,this.resetVector=0,this.IRQvector=0,this.ram=new a(65535),this.stack=new a(256)}readFromMem(e){return this.ram.read(e)}writeToMem(e,t){this.ram.write(e,t)}reset(){this.Areg=0,this.Xreg=0,this.Yreg=0,this.PC=0,this.SP=0,this.Cflag=!1,this.Zflag=!1,this.Nflag=!1,this.Iflag=!1,this.Oflag=!1,this.Dflag=!1,this.NMIvector=0,this.resetVector=0,this.IRQvector=0}loadProgram(t){for(let e=0;e<32767;e++)this.ram.write(t.read(e%t.getSize()),32768+e);console.log(this.ram.getMemory()),this.NMIvector=e.bytesToAddr(this.ram.read(65530),this.ram.read(65531)),this.resetVector=e.bytesToAddr(this.ram.read(65532),this.ram.read(65533)),console.log(`NMI: ${e.hex(this.NMIvector)}`),console.log(`RESET: ${e.hex(this.resetVector)}`),this.PC=this.resetVector}executeNextOperation(){let t=this.ram,o=t.read(this.PC),a=s.find((e=>e.opCodes.includes(o)));if(a){let s=a.name,l=a.method,i=a.opCodes.indexOf(o),c=a.addrModes[i],g=a.argTypes[i],h=a.cycles[i],u=n.get(c),m=new Uint8Array(u-1);for(let e=0;e<m.length;e++)m[e]=t.read(this.PC+e+1);let f,y=d.get(c)(t,this,m,g);switch(g){case r.value:f=y;break;case r.reference:f=t.read(y)}let p=this.PC;return this.PC+=u,l(this,f),console.log(`${e.hex(p)}: ${s.toUpperCase()} ${e.hex(y)}`,`A: ${e.hex(this.Areg)} X: ${e.hex(this.Xreg)} Y: ${e.hex(this.Yreg)}`),h}return console.log(`Invalid or unimplemented opcode: ${e.hex(o)}`),this.PC++,1}doNMI(){if(this.Iflag)return;let[t,r]=e.addrToBytes(this.getPC());this.setInterruptDisable(),this.pushToStack(this.getStatusReg()),this.pushToStack(r),this.pushToStack(t),this.setPC(this.NMIvector)}setPC(e){this.PC=e}getPC(){return this.PC}setSP(e){this.SP=255&e}getSP(){return this.SP}setAreg(e){this.setFlags(e),this.Areg=255&e}setXreg(e){this.Xreg=255&e,this.setFlags(e)}setYreg(e){this.Yreg=255&e,this.setFlags(e)}getAreg(){return this.Areg}getXreg(){return this.Xreg}getYreg(){return this.Yreg}getStatusReg(){let e=this.getFlags(),t=0,r=[];return r[1]=e.Z,r[7]=e.N,r[0]=e.C,r[2]=e.I,r[6]=e.O,r[3]=e.D,r[4]=e.B,r[5]=!0,r.forEach(((e,r)=>{e&&(t|=1>>r)})),t}setStatusReg(e){this.Zflag=Boolean(e>>1&1),this.Nflag=Boolean(e>>7&1),this.Cflag=Boolean(1&e),this.Iflag=Boolean(e>>2&1),this.Oflag=Boolean(e>>6&1),this.Dflag=Boolean(e>>3&1),this.Bflag=Boolean(e>>4&1)}pushToStack(e){this.SP--,this.stack.write(e,this.getSP())}pullFromStack(){let e=this.stack.read(this.getSP());return this.SP++,e}setCarry(){this.Cflag=!0}clearCarry(){this.Cflag=!1}setInterruptDisable(){this.Iflag=!0}clearInterruptDisable(){this.Iflag=!1}setFlags(e){e>255?this.Cflag=!0:e<0&&(this.Cflag=!1),this.Zflag=0===e,this.Nflag=!(128&~e)}getFlags(){return{Z:this.Zflag,N:this.Nflag,C:this.Cflag,I:this.Iflag,O:this.Oflag,D:this.Dflag,B:this.Bflag}}},C=new class{constructor(e,t){this.oamDmaSet=!1,this.spriteZeroHit=!1,this.testPalette=[18,22,39,24],this.ctx=e,this.cpu=t,this.ram=new a(16383),this.oam=new a(255)}loadCHR(e){for(let t=0;t<l[1];t++)this.ram.write(e.read(t),t)}copyFromOamDma(){let t=e.bytesToAddr(this.oamAddr,this.oamDma);for(let e=0;e<this.oam.getSize();e++)this.oam.write(e,this.cpu.readFromMem(t+e))}copyRegistersFromCPU(){this.oamAddr=this.cpu.readFromMem(8195),this.oamDma=this.cpu.readFromMem(16404)}writeRegistersToCPU(){}getColorIndex(e,t){return 0===t&&0===e?0:0===t&&1===e?1:1===t&&0===e?2:1===t&&1===e?3:void 0}drawSprite(e,t,r,s){let o=16*e,a=this.ram.getMemory().slice(o,o+8),n=this.ram.getMemory().slice(o+8,o+16);for(let e=0;e<a.length;e++){let s=a[e],o=n[e],d=t,l=r+e;for(let e=0;e<8;e++){let t=s>>7-e&1,r=o>>7-e&1;this.ctx.fillStyle=i[this.testPalette[this.getColorIndex(t,r)]],this.ctx.fillRect(d+e,l,1,1)}}}tick(){this.copyRegistersFromCPU(),this.writeRegistersToCPU()}draw(){for(let e=0;e<this.oam.getSize();e+=4){let t=this.oam.read(e+1),r=this.oam.read(e+3),s=this.oam.read(e),o=this.oam.read(e+2);this.drawSprite(t,r,s,o)}}}(f,p);null===(h=document.getElementById("nmi-btn"))||void 0===h||h.addEventListener("click",p.doNMI.bind(p)),null===(u=document.getElementById("romInput"))||void 0===u||u.addEventListener("change",(t=>{const r=t.target;if(r.files&&r.files[0]){const t=r.files[0],s=new FileReader;s.onload=t=>{var r;if(null===(r=t.target)||void 0===r?void 0:r.result){const r=new Uint8Array(t.target.result);!function(t){const r=function(e){let t=e.getMemory().slice(4);return{prgRomSize:16*t[0]*1024,chrRomSize:8*t[1]*1024,nametableMirroring:1&t[3],battery:Boolean(2&t[3]),mapperNumber:(240&t[3])>>4}}(t),s=t.getMemory().slice(16),o=new c(s.slice(0,r.prgRomSize)),a=new c(s.slice(r.prgRomSize,s.length-1));console.log(r),console.log(e.Uint8ArrayToHex(o.getMemory())),p.reset(),p.loadProgram(o),C.loadCHR(a),y=t}(new c(r)),F()}},s.readAsArrayBuffer(t)}}));let T=performance.now();function F(){const e=performance.now(),t=e-T;Math.floor(t/(1e3/60)*81600),Math.floor(t/(1e3/60)*2273),p.executeNextOperation(),C.tick(),C.draw(),T=e,requestAnimationFrame(F)}p.writeToMem(128,8194)})();