(()=>{"use strict";class e{static bytesToAddr(e,t){return(255&t)<<8|255&e}static addrToBytes(e){return new Uint8Array([255&e,(65280&e)>>8])}static Uint8ArrayToHex(e){return Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join(" ")}static hex(e){return null==e?"none":e.toString(16).toUpperCase().padStart(2,"0")}static binary(e){return null===e?"none":e.toString(2)}static getBit(e,t){return e>>t&1}static boolsToBitmask(e){let t=0,r=1<<e.length-1;return e.forEach(((e,s)=>{e&&(t^=r>>s)})),t}static bitmaskToBools(e){let t=Math.floor(Math.log2(e))+1,r=1<<t-1,s=new Array;for(let a=0;a<t;a++)s[a]=!!(e>>t-1-a&1)&&Boolean(e^r>>a);return s}}var t;!function(e){e[e.none=0]="none",e[e.value=1]="value",e[e.reference=2]="reference"}(t||(t={}));const r=[{name:"brk",method:function(e,t){},opCodes:[0],addrModes:[0],argTypes:[null],cycles:[1]},{name:"lda",method:function(e,t){e.setAreg(t)},opCodes:[169,165,181,173,189,161,177],addrModes:[1,2,3,5,6,7,11,12],argTypes:[t.value,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"sta",method:function(e,t){e.writeToMem(e.getAreg(),t)},opCodes:[133,149,141,157,153,129,145],addrModes:[2,3,5,6,7,11,12],argTypes:[t.value,t.value,t.value,t.value,t.value,t.value,t.value],cycles:[3,4,4,5,5,6,6]},{name:"ldx",method:function(e,t){e.setXreg(t)},opCodes:[162,166,182,174,190],addrModes:[1,2,4,5,7],argTypes:[t.value,t.reference,t.reference,t.reference,t.reference],cycles:[2,3,4,4,4]},{name:"stx",method:function(e,t){e.writeToMem(e.getXreg(),t)},opCodes:[134,150,142],addrModes:[2,4,5],argTypes:[t.value,t.value,t.value],cycles:[3,4,4]},{name:"ldy",method:function(e,t){e.setYreg(t)},opCodes:[160,164,180,172,188],addrModes:[1,2,3,5,6],argTypes:[t.value,t.reference,t.reference,t.reference,t.reference],cycles:[2,3,4,4,4]},{name:"sty",method:function(e,t){e.writeToMem(e.getYreg(),t)},opCodes:[132,148,140],addrModes:[2,3,5],argTypes:[t.value,t.value,t.value],cycles:[3,4,4]},{name:"tax",method:function(e,t){e.setXreg(e.getAreg())},opCodes:[170],addrModes:[0],argTypes:[null],cycles:[2]},{name:"txa",method:function(e,t){e.setAreg(e.getXreg())},opCodes:[138],addrModes:[0],argTypes:[null],cycles:[2]},{name:"tay",method:function(e,t){e.setYreg(e.getAreg())},opCodes:[168],addrModes:[0],argTypes:[null],cycles:[2]},{name:"tya",method:function(e,t){e.setAreg(e.getYreg())},opCodes:[152],addrModes:[0],argTypes:[null],cycles:[2]},{name:"tsx",method:function(e,t){e.setXreg(e.getSP())},opCodes:[186],addrModes:[0],argTypes:[null],cycles:[2]},{name:"txs",method:function(e,t){e.setSP(e.getXreg())},opCodes:[154],addrModes:[0],argTypes:[null],cycles:[2]},{name:"jmp",method:function(e,t){e.setPC(t)},opCodes:[76,108],addrModes:[5,10],argTypes:[t.value,t.reference],cycles:[3,5]},{name:"jsr",method:function(t,r){let s=t.getPC(),[a,o]=e.addrToBytes(s);t.pushToStack(o),t.pushToStack(a),t.setPC(r)},opCodes:[32],addrModes:[5],argTypes:[t.value],cycles:[6]},{name:"rts",method:function(t,r){let s=t.pullFromStack(),a=t.pullFromStack(),o=e.bytesToAddr(s,a);t.setPC(o)},opCodes:[96],addrModes:[0],argTypes:[null],cycles:[6]},{name:"rti",method:function(t,r){let s=t.pullFromStack(),a=t.pullFromStack(),o=t.pullFromStack(),i=e.bytesToAddr(s,a);t.setStatusReg(o),t.setPC(i),console.log(`Returned from interrupt to ${e.hex(i)}`)},opCodes:[64],addrModes:[0],argTypes:[null],cycles:[6]},{name:"inc",method:function(e,t){e.writeToMem(e.readFromMem(t)+1,t)},opCodes:[230,246,238,254],addrModes:[2,3,5,6],argTypes:[t.value,t.value,t.value,t.value],cycles:[5,6,6,7]},{name:"dec",method:function(e,t){e.writeToMem(e.readFromMem(t)-1,t)},opCodes:[198,214,206,222],addrModes:[2,3,5,6],argTypes:[t.value,t.value,t.value,t.value],cycles:[5,6,6,7]},{name:"inx",method:function(e,t){let r=e.getXreg()+1;e.setXreg(r)},opCodes:[232],addrModes:[0],argTypes:[null],cycles:[2]},{name:"dex",method:function(e,t){let r=e.getXreg()-1;e.setXreg(r)},opCodes:[202],addrModes:[0],argTypes:[null],cycles:[2]},{name:"iny",method:function(e,t){let r=e.getYreg()+1;e.setYreg(r)},opCodes:[200],addrModes:[0],argTypes:[null],cycles:[2]},{name:"dey",method:function(e,t){let r=e.getYreg()-1;e.setYreg(r)},opCodes:[136],addrModes:[0],argTypes:[null],cycles:[2]},{name:"sec",method:function(e,t){e.setCarry()},opCodes:[56],addrModes:[0],argTypes:[null],cycles:[2]},{name:"clc",method:function(e,t){e.clearCarry()},opCodes:[24],addrModes:[0],argTypes:[null],cycles:[2]},{name:"adc",method:function(e,t){let r=Number(e.getFlags().C),s=e.getAreg()+t+r;e.setAreg(s),s>255?e.setCarry():e.clearCarry()},opCodes:[105,101,117,109,125,121,97,113],addrModes:[1,2,3,5,6,7,11,12],argTypes:[t.value,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"sbc",method:function(e,t){let r=Number(!e.getFlags().C),s=e.getAreg()-t-r;e.setAreg(s),s<0?e.clearCarry():e.setCarry()},opCodes:[233,229,245,237,253,249,225,241],addrModes:[1,2,3,5,6,7,11,12],argTypes:[t.value,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"cmp",method:function(e,t){let r=e.getAreg()-t;e.setFlags(r),r<0?e.clearCarry():e.setCarry()},opCodes:[201,197,213,205,221,217,193,209],addrModes:[1,2,3,5,6,7,11,12],argTypes:[t.value,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"cpx",method:function(e,t){let r=e.getXreg()-t;e.setFlags(r),r<0?e.clearCarry():e.setCarry()},opCodes:[224,228,236],addrModes:[1,2,5],argTypes:[t.value,t.reference,t.reference],cycles:[2,3,4]},{name:"cpy",method:function(e,t){let r=e.getYreg()-t;e.setFlags(r),r<0?e.clearCarry():e.setCarry()},opCodes:[192,196,204],addrModes:[1,2,5],argTypes:[t.value,t.reference,t.reference],cycles:[2,3,4]},{name:"bit",method:function(e,t){e.setFlags(t),128&~t?e.clearNegative():e.setNegative(),64&~t?e.clearOverflow():e.setOverflow()},opCodes:[36,44],addrModes:[2,5],argTypes:[t.reference,t.reference],cycles:[3,4]},{name:"beq",method:function(e,t){e.getFlags().Z&&e.setPC(t)},opCodes:[240],addrModes:[9],argTypes:[t.value],cycles:[2]},{name:"bne",method:function(e,t){e.getFlags().Z||e.setPC(t)},opCodes:[208],addrModes:[9],argTypes:[t.value],cycles:[2]},{name:"bcc",method:function(e,t){e.getFlags().C||e.setPC(t)},opCodes:[144],addrModes:[9],argTypes:[t.value],cycles:[2]},{name:"bcs",method:function(e,t){e.getFlags().C&&e.setPC(t)},opCodes:[176],addrModes:[9],argTypes:[t.value],cycles:[2]},{name:"bmi",method:function(e,t){e.getFlags().N&&e.setPC(t)},opCodes:[48],addrModes:[9],argTypes:[t.value],cycles:[2]},{name:"bpl",method:function(e,t){e.getFlags().N||e.setPC(t)},opCodes:[16],addrModes:[9],argTypes:[t.value],cycles:[2]},{name:"and",method:function(e,t){e.setAreg(e.getAreg()&t)},opCodes:[41,37,53,45,61,57,33,49],addrModes:[1,2,3,5,6,7,11,12],argTypes:[t.value,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"ora",method:function(e,t){e.setAreg(e.getAreg()|t)},opCodes:[9,5,21,13,29,25,1,17],addrModes:[1,2,3,5,6,7,11,12],argTypes:[t.value,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"eor",method:function(e,t){e.setAreg(e.getAreg()^t)},opCodes:[73,69,85,77,93,89,65,81],addrModes:[1,2,3,5,6,7,11,12],argTypes:[t.value,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference,t.reference],cycles:[2,3,4,4,4,4,6,5]},{name:"pha",method:function(e,t){e.pushToStack(e.getAreg())},opCodes:[72],addrModes:[0],argTypes:[null],cycles:[3]},{name:"pla",method:function(e,t){e.setAreg(e.pullFromStack())},opCodes:[104],addrModes:[0],argTypes:[null],cycles:[4]},{name:"php",method:function(e,t){e.pushToStack(e.getStatusReg())},opCodes:[8],addrModes:[0],argTypes:[null],cycles:[3]},{name:"plp",method:function(e,t){e.setStatusReg(e.pullFromStack())},opCodes:[40],addrModes:[0],argTypes:[null],cycles:[4]}],s=new Map;r.forEach((e=>{e.opCodes.forEach(((t,r)=>{s.set(t,{name:e.name,method:e.method,addrMode:e.addrModes[r],argType:e.argTypes[r],cycles:e.cycles[r]})}))}));class a{constructor(e,t){this.memory=t||new Uint8Array(e).fill(0)}read(e){return this.memory[e]}readRange(e,t){return this.memory.slice(e,t)}write(e,t){this.memory[t]=e}getSize(){return this.memory.length}getMemory(){return this.memory}setMemory(e){this.memory=e}}class o extends a{constructor(e,t){super(e,t)}}const i=new Map([[0,1],[1,2],[2,2],[3,2],[4,2],[5,3],[6,3],[7,3],[8,1],[9,2],[10,3],[11,2],[12,2]]),n=new Map([[0,function(e,t,r,s){return null}],[1,function(e,t,r,s){return r[0]}],[2,function(e,t,r,s){return r[0]}],[3,function(e,t,r,s){return r[0]+t.getXreg()}],[4,function(e,t,r,s){return r[0]+t.getYreg()}],[5,function(t,r,s,a){return e.bytesToAddr(s[0],s[1])}],[6,function(t,r,s,a){return e.bytesToAddr(s[0],s[1])+r.getXreg()}],[7,function(t,r,s,a){return e.bytesToAddr(s[0],s[1])+r.getYreg()}],[8,function(e,t,r,s){return t.getAreg()}],[9,function(e,t,r,s){let a=128&~r[0]?r[0]+2:r[0]-254;return t.getPC()+a}],[10,function(t,r,s,a){let o=e.bytesToAddr(s[0],s[1]),i=t.read(o),n=t.read(o+1);return e.bytesToAddr(i,n)}],[11,function(t,r,s,a){let o=e.bytesToAddr(s[0],s[1])+r.getXreg(),i=t.read(o),n=t.read(o+1);return e.bytesToAddr(i,n)}],[12,function(t,r,s,a){let o=e.bytesToAddr(s[0],s[1]),i=t.read(o),n=t.read(o+1);return e.bytesToAddr(i,n)+r.getYreg()}]]),l=[[124,124,124],[0,0,252],[0,0,188],[68,40,188],[148,0,132],[168,0,32],[168,16,0],[136,20,0],[80,48,0],[0,120,0],[0,104,0],[0,88,0],[0,64,88],[0,0,0],[0,0,0],[0,0,0],[188,188,188],[0,120,248],[0,88,248],[104,68,252],[216,0,204],[228,0,88],[248,56,0],[228,92,16],[172,124,0],[0,184,0],[0,168,0],[0,168,68],[0,136,136],[0,0,0],[0,0,0],[0,0,0],[248,248,248],[60,188,252],[104,136,252],[152,120,248],[248,120,248],[248,88,152],[248,120,88],[252,160,68],[248,184,0],[184,248,24],[88,216,84],[88,248,152],[0,232,216],[120,120,120],[0,0,0],[0,0,0],[252,252,252],[164,228,252],[184,184,248],[216,184,248],[248,184,248],[248,164,192],[240,208,176],[252,224,168],[248,216,120],[216,248,120],[184,248,184],[184,248,216],[0,252,252],[248,216,248],[0,0,0],[0,0,0]];class d extends a{constructor(e){super(e.length,e)}write(e,t){throw new Error("Did you just try to write to a ROM? Read-only memory? What is wrong with you? Why would you do that?")}}var c;!function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(c||(c={}));class h{constructor(){}setPrgRom(e){this.rom=e}getPrgRom(){return this.rom}}const g=new Map([[0,new class extends h{constructor(){super()}read(e){return this.rom.read((e-32768)%this.getPrgRom().getSize())}write(e,t){}}]]);var u,m;let f,p=document.getElementById("canvas"),y=p.getContext("2d");y.imageSmoothingEnabled=!1,p.width=1024,p.height=960;let C=new class{constructor(){this.Areg=0,this.Xreg=0,this.Yreg=0,this.PC=0,this.SP=0,this.Cflag=!1,this.Zflag=!1,this.Nflag=!1,this.Iflag=!1,this.Oflag=!1,this.Dflag=!1,this.Bflag=!1,this.NMIvector=0,this.resetVector=0,this.IRQvector=0,this.stack=new o(256)}setBus(e){this.bus=e}readFromMem(e){return this.bus.read(e)}writeToMem(e,t){this.bus.write(e,t)}reset(){this.Areg=0,this.Xreg=0,this.Yreg=0,this.PC=0,this.SP=0,this.Cflag=!1,this.Zflag=!1,this.Nflag=!1,this.Iflag=!1,this.Oflag=!1,this.Dflag=!1,this.NMIvector=0,this.resetVector=0,this.IRQvector=0}loadProgram(t){this.NMIvector=e.bytesToAddr(this.bus.read(65530),this.bus.read(65531)),this.resetVector=e.bytesToAddr(this.bus.read(65532),this.bus.read(65533)),console.log(`NMI: ${e.hex(this.NMIvector)}`),console.log(`RESET: ${e.hex(this.resetVector)}`),this.PC=this.resetVector}executeNextOperation(){let e=this.bus.read(this.PC),r=s.get(e);if(r){r.name;let e=r.method,s=r.addrMode,a=r.argType,o=r.cycles,l=i.get(s),d=new Uint8Array(l-1);for(let e=0;e<d.length;e++)d[e]=this.bus.read(this.PC+e+1);let c,h=n.get(s)(this.bus,this,d,a);switch(a){case t.value:c=h;break;case t.reference:c=this.bus.read(h)}return this.PC,this.PC+=l,e(this,c),o}return this.PC++,1}goToNMI(){let[t,r]=e.addrToBytes(this.getPC());this.setInterruptDisable(),this.pushToStack(this.getStatusReg()),this.pushToStack(r),this.pushToStack(t),this.setPC(this.NMIvector)}setPC(e){this.PC=e}getPC(){return this.PC}setSP(e){this.SP=255&e}getSP(){return this.SP}setAreg(e){this.setFlags(e),this.Areg=255&e}setXreg(e){this.Xreg=255&e,this.setFlags(this.Xreg)}setYreg(e){this.Yreg=255&e,this.setFlags(this.Yreg)}getAreg(){return this.Areg}getXreg(){return this.Xreg}getYreg(){return this.Yreg}getStatusReg(){let t=this.getFlags();return e.boolsToBitmask([t.N,t.O,!0,t.B,t.D,t.I,t.Z,t.C])}setStatusReg(t){let r;[this.Nflag,this.Oflag,r,this.Bflag,this.Dflag,this.Iflag,this.Zflag,this.Cflag]=e.bitmaskToBools(t)}pushToStack(e){this.SP--,this.stack.write(e,this.getSP())}pullFromStack(){let e=this.stack.read(this.getSP());return this.SP++,e}setCarry(){this.Cflag=!0}clearCarry(){this.Cflag=!1}setZero(){this.Zflag=!0}clearZero(){this.Zflag=!1}setNegative(){this.Nflag=!0}clearNegative(){this.Nflag=!1}setOverflow(){this.Oflag=!0}clearOverflow(){this.Oflag=!1}setInterruptDisable(){this.Iflag=!0}clearInterruptDisable(){this.Iflag=!1}setFlags(e){this.Zflag=0===e,this.Nflag=!(128&~e)}getFlags(){return{Z:this.Zflag,N:this.Nflag,C:this.Cflag,I:this.Iflag,O:this.Oflag,D:this.Dflag,B:this.Bflag}}},w=new class{constructor(e){this.outputScaleX=4,this.outputScaleY=4,this.patternTables=[new o(4096),new o(4096)],this.nameTables=[new o(1024),new o(1024),new o(1024),new o(1024)],this.backgroundPalettes=new o(16),this.spritePalettes=new o(16),this.oam=new o(255),this.memoryMap=new Map([[[0,4095],this.patternTables[0]],[[4096,8191],this.patternTables[1]],[[8192,9215],this.nameTables[0]],[[9216,10239],this.nameTables[1]],[[10240,11263],this.nameTables[2]],[[11264,12287],this.nameTables[3]],[[16128,16143],this.backgroundPalettes],[[16144,16159],this.spritePalettes]]),this.mirroringMode=0,this.writeAddr=null,this.writeCounter=0,this.scrollX=0,this.scrollY=0,this.oamDmaSet=!1,this.NMIenabled=!1,this.masterSlave=!1,this.spriteSizeMode=!1,this.backgroundAddr=!1,this.spriteAddr=!1,this.vramIncrement=!1,this.currentNametable=0,this.emphasizeBlue=!1,this.emphasizeGreen=!1,this.emphasizeRed=!1,this.showSprites=!1,this.showBackground=!1,this.showLeftSprites=!1,this.showLeftBackground=!1,this.greyscale=!1,this.inVblank=!0,this.spriteZeroHit=!1,this.spriteOverflow=!1,this.testPalette=[18,22,39,24],this.ctx=e,this.frameBuffer=this.ctx.createImageData(this.ctx.canvas.width,this.ctx.canvas.height)}setNMIhandler(e){this.NMIhandler=e}setBus(e){this.bus=e}setMirroringMode(e){this.mirroringMode=e}loadCHR(e){let t=this.patternTables[0],r=this.patternTables[1];for(let s=0;s<t.getSize();s++)t.write(e.read(s),s),r.write(e.read(s+t.getSize()),s)}copySpritesFromOamDma(){let t=e.bytesToAddr(this.oamAddr,this.oamDma);for(let e=0;e<this.oam.getSize();e++)this.oam.write(this.bus.read(t+e),e)}writeToMem(e,t){let r=Array.from(this.memoryMap),s=r.findIndex((([e,r])=>t%16160>=e[0]&&t%16160<=e[1])),a=r[s][0][0];r[s][1].write(e,t-a)}tick(){}NMI(){this.NMIenabled&&this.NMIhandler()}readRegister(t){switch(t){case 8192:return e.boolsToBitmask([this.NMIenabled,this.masterSlave,this.spriteSizeMode,this.backgroundAddr,this.spriteAddr,this.vramIncrement,Boolean(e.getBit(this.currentNametable,1)),Boolean(e.getBit(this.currentNametable,0))]);case 8194:return this.writeCounter=0,e.boolsToBitmask([this.inVblank,this.spriteZeroHit,this.spriteOverflow,!1,!1,!1,!1,!1]);case 8193:return e.boolsToBitmask([this.emphasizeBlue,this.emphasizeGreen,this.emphasizeRed,this.showSprites,this.showBackground,this.showLeftSprites,this.showLeftBackground,this.greyscale]);case 8195:return this.oamAddr;case 8196:return this.oam.read(this.oamAddr);default:return 0}}writeRegister(t,r){switch(r){case 8192:[this.NMIenabled,this.masterSlave,this.spriteSizeMode,this.backgroundAddr,this.spriteAddr,this.vramIncrement]=e.bitmaskToBools(t),this.currentNametable=3&t;break;case 8193:[this.emphasizeBlue,this.emphasizeGreen,this.emphasizeRed,this.showSprites,this.showBackground,this.showLeftSprites,this.showLeftBackground,this.greyscale]=e.bitmaskToBools(t);break;case 16404:this.oamDma=t;break;case 8195:this.oamAddr=t;break;case 8196:this.oam.write(t,this.oamAddr);break;case 8197:0===this.writeCounter?this.scrollX=t:1===this.writeCounter&&(this.scrollY=t),this.writeCounter++,this.writeCounter>1&&(this.writeCounter=0);break;case 8198:0===this.writeCounter?(this.writeAddr=0,this.writeAddr|=t<<8):1===this.writeCounter&&(this.writeAddr|=t),this.writeCounter++,this.writeCounter>1&&(this.writeCounter=0);break;case 8199:null!==this.writeAddr&&(this.writeToMem(t,this.writeAddr),this.writeAddr+=this.vramIncrement?32:1)}}getColorIndex(e,t){return 0===t&&0===e?0:0===t&&1===e?1:1===t&&0===e?2:1===t&&1===e?3:void 0}drawPixel(e,t,r,s=1,a=1){for(let o=0;o<s;o++)for(let i=0;i<a;i++){let n=4*((t*a+i)*this.ctx.canvas.width+(e*s+o));this.frameBuffer.data[n]=r[0],this.frameBuffer.data[n+1]=r[1],this.frameBuffer.data[n+2]=r[2],this.frameBuffer.data[n+3]=255}}drawTile(e,t,r,s,a,o,i,n,d,c){let h=16*e,g=d.getMemory().slice(h,h+8),u=d.getMemory().slice(h+8,h+16),m=n.readRange(s,s+4);for(let e=0;e<g.length;e++){let s=g[e],a=u[e],o=t,i=r+e;for(let e=0;e<8;e++){let t=s>>7-e&1,r=a>>7-e&1,n=this.getColorIndex(t,r),d=m[n],h=l[d];0===n&&c||this.drawPixel(o+e,i,h,this.outputScaleX,this.outputScaleY)}}}drawSprites(){for(let t=0;t+4<this.oam.getSize();t+=4){let r=this.oam.read(t+1),s=this.oam.read(t+3),a=this.oam.read(t),o=3&this.oam.read(t+2);0!==r&&console.log(`Drawing sprite $${e.hex(r)} at X: ${e.hex(s)} Y: ${e.hex(a)}`),this.drawTile(r,s,a,o,!1,!1,!1,this.spritePalettes,this.patternTables[0],!0)}}drawBackground(){let e=this.nameTables[this.currentNametable];for(let t=0;t<e.getSize();t++){let r=e.read(t),s=t%32*8,a=8*Math.floor(t/32);this.drawTile(r,s,a,0,!1,!1,!1,this.backgroundPalettes,this.patternTables[1],!1)}}draw(){this.copySpritesFromOamDma(),this.drawBackground(),this.drawSprites(),this.ctx.putImageData(this.frameBuffer,0,0),this.frameBuffer=this.ctx.createImageData(this.ctx.canvas.width,this.ctx.canvas.height);for(let t=0;t<this.backgroundPalettes.getSize();t++){let r=l[this.backgroundPalettes.read(t)],s="#"+e.hex(r[0])+e.hex(r[1])+e.hex(r[2]);this.ctx.fillStyle=s,this.ctx.fillRect(16*t,0,16,16)}}}(y);w.setNMIhandler(C.goToNMI.bind(C));let T,M=new class{constructor(e,t){this.cpu=e,this.ppu=t,this.ram=new o(2048)}setMapper(e){this.mapper=e}read(t){if(t<8192)return this.ram.read(t%2048);if(t<16384)try{return this.ppu.readRegister(8192+t%8)}catch(t){throw new Error(`PC: ${e.hex(this.cpu.getPC())}  ${t.message}`)}else if(t>=32768)return this.mapper.read(t);return 0}write(e,t){if(t<8192)this.ram.write(e,t%2048);else if(t<16384)try{this.ppu.writeRegister(e,8192+t%8)}catch(e){}else 16404===t?this.ppu.writeRegister(e,t):t>32768&&this.mapper.write(e,t)}}(C,w);C.setBus(M),w.setBus(M),null===(u=document.getElementById("nmi-btn"))||void 0===u||u.addEventListener("click",w.NMI.bind(w)),null===(m=document.getElementById("romInput"))||void 0===m||m.addEventListener("change",(t=>{const r=t.target;if(r.files&&r.files[0]){const t=r.files[0],s=new FileReader;s.onload=t=>{var r;if(null===(r=t.target)||void 0===r?void 0:r.result){const r=new Uint8Array(t.target.result);!function(t){const r=function(e){let t=e.getMemory().slice(4);return{prgRomSize:16*t[0]*1024,chrRomSize:8*t[1]*1024,nametableMirroring:1&t[3],battery:Boolean(2&t[3]),mapperNumber:(240&t[3])>>4}}(t),s=t.getMemory().slice(16),a=new d(s.slice(0,r.prgRomSize)),o=new d(s.slice(r.prgRomSize,s.length-1));console.log(r),console.log(e.Uint8ArrayToHex(a.getMemory())),f=g.get(r.mapperNumber),f.setPrgRom(a),M.setMapper(f),console.log(f),C.reset(),C.loadProgram(a),w.loadCHR(o),T=t}(new d(r)),v()}},s.readAsArrayBuffer(t)}}));let b=performance.now();function v(){const t=performance.now(),r=(t-b)/(1e3/60),s=Math.floor(27120*r),a=Math.floor(2486*r);let o=0;for(console.log(`FRAME START  PC: ${e.hex(C.getPC())}`);o<s;)o+=C.executeNextOperation(),w.tick();for(console.log(`FRAME END  PC: ${e.hex(C.getPC())}`),o=0,w.NMI(),console.log(`NMI START  PC: ${e.hex(C.getPC())}`);o<a;)o+=C.executeNextOperation(),w.tick();console.log(`NMI END  PC: ${e.hex(C.getPC())}`),w.draw(),b=t,requestAnimationFrame(v)}})();